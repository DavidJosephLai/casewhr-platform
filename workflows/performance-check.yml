name: Performance Budget Check

# åœ¨ PR å’Œä¸»åˆ†æ”¯æ¨é€æ™‚é‹è¡Œæ€§èƒ½æª¢æŸ¥
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  performance-check:
    name: Check Performance Budget
    runs-on: ubuntu-latest
    
    steps:
      # 1. æª¢å‡ºä»£ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿æ¯”è¼ƒ

      # 2. è¨­ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. å®‰è£ä¾è³´
      - name: Install dependencies
        run: npm ci

      # 4. æ§‹å»ºç”Ÿç”¢ç‰ˆæœ¬
      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production

      # 5. åˆ†æ Bundle å¤§å°
      - name: Analyze bundle size
        run: |
          echo "ğŸ“¦ Bundle Size Analysis"
          echo "======================"
          
          # ä½¿ç”¨ du å‘½ä»¤è¨ˆç®—å¤§å°
          TOTAL_JS=$(du -ch dist/assets/*.js 2>/dev/null | grep total | awk '{print $1}')
          TOTAL_CSS=$(du -ch dist/assets/*.css 2>/dev/null | grep total | awk '{print $1}')
          
          echo "Total JavaScript: $TOTAL_JS"
          echo "Total CSS: $TOTAL_CSS"
          
          # è¼¸å‡ºæ‰€æœ‰æ–‡ä»¶å¤§å°
          echo ""
          echo "JavaScript files:"
          du -h dist/assets/*.js 2>/dev/null | sort -hr | head -10
          
          echo ""
          echo "CSS files:"
          du -h dist/assets/*.css 2>/dev/null | sort -hr

      # 6. é‹è¡Œæ€§èƒ½æ¸¬è©¦è…³æœ¬
      - name: Run performance tests
        run: node scripts/test-performance.js
        continue-on-error: true

      # 7. å•Ÿå‹•é è¦½æœå‹™å™¨ï¼ˆèƒŒæ™¯ï¼‰
      - name: Start preview server
        run: |
          npm run preview &
          sleep 5
          echo "Preview server started"

      # 8. é‹è¡Œ Lighthouse CI
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173
            http://localhost:4173/browse
            http://localhost:4173/pricing
          budgetPath: ./performance-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      # 9. é‹è¡Œè‡ªå®šç¾©æ€§èƒ½é ç®—æª¢æŸ¥
      - name: Check performance budget
        run: node scripts/check-performance-budget.js
        continue-on-error: true

      # 10. ç”Ÿæˆæ€§èƒ½å ±å‘Š
      - name: Generate performance report
        run: |
          node scripts/generate-performance-report.js
        continue-on-error: true

      # 11. ä¸Šå‚³æ€§èƒ½å ±å‘Šä½œç‚º Artifact
      - name: Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: |
            .lighthouseci/
            performance-report.json
            performance-report.html
            performance-report.md
          retention-days: 30

      # 12. è©•è«– PRï¼ˆå¦‚æœæ˜¯ PRï¼‰
      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è®€å–æ€§èƒ½å ±å‘Š
            let report = '';
            try {
              report = fs.readFileSync('performance-report.md', 'utf8');
            } catch (error) {
              report = 'âŒ ç„¡æ³•ç”Ÿæˆæ€§èƒ½å ±å‘Š';
            }
            
            // è©•è«–åˆ° PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“Š æ€§èƒ½æª¢æŸ¥å ±å‘Š\n\n${report}`
            });

  # Bundle å¤§å°å°æ¯”
  bundle-size-diff:
    name: Compare Bundle Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install and build PR version
        run: |
          npm ci
          npm run build
          
      - name: Save PR bundle size
        run: |
          du -ch dist/assets/*.js | grep total | awk '{print $1}' > pr-bundle-size.txt
          cat pr-bundle-size.txt

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Build base version
        run: |
          npm ci
          npm run build

      - name: Compare bundle sizes
        run: |
          BASE_SIZE=$(du -ch dist/assets/*.js | grep total | awk '{print $1}')
          PR_SIZE=$(cat pr-bundle-size.txt)
          
          echo "Base branch bundle size: $BASE_SIZE"
          echo "PR branch bundle size: $PR_SIZE"
          
          # å‰µå»ºå°æ¯”å ±å‘Š
          echo "# Bundle Size Comparison" > bundle-diff.md
          echo "" >> bundle-diff.md
          echo "| Branch | Size |" >> bundle-diff.md
          echo "|--------|------|" >> bundle-diff.md
          echo "| Base (${{ github.base_ref }}) | $BASE_SIZE |" >> bundle-diff.md
          echo "| PR | $PR_SIZE |" >> bundle-diff.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-size-comparison
          path: bundle-diff.md

  # æ€§èƒ½ç›£æ§ï¼ˆå®šæœŸé‹è¡Œï¼‰
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run build

      - name: Deploy to Vercel (preview)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Run Lighthouse on production
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://casewhr.com
            https://casewhr.com/browse
            https://casewhr.com/pricing
            https://casewhr.com/about
          budgetPath: ./performance-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Send monitoring alert if needed
        if: failure()
        run: |
          echo "âš ï¸ æ€§èƒ½ç›£æ§æª¢æ¸¬åˆ°å•é¡Œï¼Œè«‹æŸ¥çœ‹å ±å‘Š"
          # å¯ä»¥åœ¨é€™è£¡æ·»åŠ  Slack é€šçŸ¥ç­‰
